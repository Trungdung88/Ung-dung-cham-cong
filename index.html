<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Chấm Công (Lưu Dữ Liệu Cục Bộ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border: 1px solid #e2e8f0;
            white-space: nowrap;
            text-align: center;
        }
        th:first-child, td:first-child,
        th:nth-child(2), td:nth-child(2) {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: white;
        }
        th:first-child, td:first-child {
            width: 200px;
            min-width: 200px;
        }
        th:nth-child(2), td:nth-child(2) {
            left: 200px;
            width: 150px;
            min-width: 150px;
        }
        .weekend {
            background-color: #f7fafc;
        }
        .status-popover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Main App Content -->
    <div id="app" class="p-4 sm:p-6 lg:p-8">
        
        <!-- Warning Banner -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md" role="alert">
            <p class="font-bold">Lưu ý</p>
            <p>Dữ liệu chấm công đang được lưu trực tiếp trên trình duyệt này. Dữ liệu sẽ không được đồng bộ với các máy tính khác.</p>
        </div>

        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Bảng Chấm Công Điện Tử</h1>
                <p class="text-sm text-gray-500">Trường Trung Cấp Đông Sài Gòn</p>
            </div>
            <div id="user-actions" class="flex items-center space-x-4 mt-4 sm:mt-0">
                <div class="flex items-center space-x-2">
                    <label for="user-select" class="text-sm font-medium">Người dùng:</label>
                    <select id="user-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- User options will be populated by JS -->
                    </select>
                </div>
                <button id="export-csv-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                    Xuất File
                </button>
            </div>
        </div>

        <!-- Month Navigator -->
        <div class="flex items-center justify-center space-x-4 bg-white p-3 rounded-lg shadow-sm mb-6">
            <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-100">&lt; Tháng Trước</button>
            <h2 id="current-month-display" class="text-xl font-bold w-48 text-center"></h2>
            <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-100">Tháng Sau &gt;</button>
            <button id="today-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">Hôm Nay</button>
        </div>

        <!-- Timesheet Table -->
        <div id="timesheet-container" class="table-container bg-white rounded-lg shadow-sm">
            <table class="w-full text-sm">
                <thead id="timesheet-head" class="bg-gray-100 text-gray-600 uppercase">
                </thead>
                <tbody id="timesheet-body">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Status Update Popover (Admin only) -->
    <div id="status-popover" class="status-popover hidden absolute bg-white border border-gray-200 rounded-lg p-2 z-20">
         <div class="grid grid-cols-4 gap-2">
            <button data-status="X" class="status-btn font-bold text-green-600 bg-green-100 hover:bg-green-200 rounded p-2 text-sm">X</button>
            <button data-status="X/2" class="status-btn font-bold text-teal-600 bg-teal-100 hover:bg-teal-200 rounded p-2 text-sm">X/2</button>
            <button data-status="P" class="status-btn font-bold text-blue-600 bg-blue-100 hover:bg-blue-200 rounded p-2 text-sm">P</button>
            <button data-status="VR" class="status-btn font-bold text-indigo-600 bg-indigo-100 hover:bg-indigo-200 rounded p-2 text-sm">VR</button>
            <button data-status="No" class="status-btn font-bold text-orange-600 bg-orange-100 hover:bg-orange-200 rounded p-2 text-sm">No</button>
            <button data-status="Nb" class="status-btn font-bold text-cyan-600 bg-cyan-100 hover:bg-cyan-200 rounded p-2 text-sm">Nb</button>
            <button data-status="L" class="status-btn font-bold text-purple-600 bg-purple-100 hover:bg-purple-200 rounded p-2 text-sm">L</button>
            <button data-status="Ô" class="status-btn font-bold text-amber-600 bg-amber-100 hover:bg-amber-200 rounded p-2 text-sm">Ô</button>
            <button data-status="Ts" class="status-btn font-bold text-pink-600 bg-pink-100 hover:bg-pink-200 rounded p-2 text-sm">Ts</button>
            <button data-status="H" class="status-btn font-bold text-gray-600 bg-gray-200 hover:bg-gray-300 rounded p-2 text-sm">H</button>
            <button data-status="Cđ" class="status-btn font-bold text-lime-600 bg-lime-100 hover:bg-lime-200 rounded p-2 text-sm">Cđ</button>
            <button data-status="" class="status-btn font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 rounded p-2 text-xs">Xóa</button>
        </div>
    </div>
    
    <script>
        // --- CONFIG & STATE ---
        const ADMIN_NAME = 'Trần Nguyễn Trung Dũng';
        
        let currentUserInfo = { id: null, name: null, email: null, isAdmin: false };
        let currentDate = new Date(2025, 0, 1);
        let employees = [];
        let attendanceData = {}; 
        
        const popover = document.getElementById('status-popover');
        let currentCell = { employeeId: null, day: null };

        // --- STATUS CONFIG ---
        const STATUS_MAP = { "X": { text: "X", class: "bg-green-100 text-green-800 font-semibold" }, "X/2": { text: "X/2", class: "bg-teal-100 text-teal-800 font-semibold" }, "P": { text: "P", class: "bg-blue-100 text-blue-800 font-semibold" }, "VR": { text: "VR", class: "bg-indigo-100 text-indigo-800 font-semibold" }, "L": { text: "L", class: "bg-purple-100 text-purple-800 font-semibold" }, "Ô": { text: "Ô", class: "bg-amber-100 text-amber-800 font-semibold" }, "Ts": { text: "Ts", class: "bg-pink-100 text-pink-800 font-semibold" }, "Nb": { text: "Nb", class: "bg-cyan-100 text-cyan-800 font-semibold" }, "No": { text: "No", class: "bg-orange-100 text-orange-800 font-semibold" }, "H": { text: "H", class: "bg-gray-200 text-gray-700 font-semibold" }, "Cđ": { text: "Cđ", class: "bg-lime-100 text-lime-800 font-semibold" }, };
        const STATUS_COUNT = { workDays: { label: 'Công', statuses: {'X': 1, 'X/2': 0.5, 'H': 1, 'Cđ': 1} }, paidLeave: { label: 'Nghỉ P', statuses: {'P': 1} }, unpaidLeave: { label: 'Nghỉ KL', statuses: {'No': 1, 'VR': 1} }, insuranceLeave: { label: 'Nghỉ BHXH', statuses: {'Ô': 1, 'Ts': 1} }, holiday: { label: 'Lễ', statuses: {'L': 1} }, compensatedLeave: { label: 'Nghỉ Bù', statuses: {'Nb': 1} }, };

        // --- DATA HANDLING with localStorage ---
        function getStorageKey() {
            return `attendanceData-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
        }

        function saveAttendanceToStorage() {
            localStorage.setItem(getStorageKey(), JSON.stringify(attendanceData));
        }

        function loadAttendanceFromStorage() {
            const savedData = localStorage.getItem(getStorageKey());
            attendanceData = savedData ? JSON.parse(savedData) : {};
        }

        function loadInitialData() {
            employees = [
                { id: 'emp1', name: 'Trần Huyền Vân', position: 'Phó Hiệu Trưởng', sortOrder: 1 },
                { id: 'emp2', name: 'Trần Nguyễn Trung Dũng', position: 'TP. Đào tạo', sortOrder: 2 },
                { id: 'emp3', name: 'Đoàn Hồng Hải Vân', position: 'VC. P. Đào tạo', sortOrder: 3 },
                { id: 'emp4', name: 'Nguyễn Thùy Dung', position: 'VC. P. Đào tạo', sortOrder: 4 },
                { id: 'emp5', name: 'Võ Hoàng Thanh', position: 'VC. P. Đào tạo', sortOrder: 5 },
            ];
            employees.sort((a, b) => a.sortOrder - b.sortOrder);
        }

        function updateAttendance(employeeId, day, status) {
            if (!attendanceData[employeeId]) {
                attendanceData[employeeId] = {};
            }
            if (status) {
                attendanceData[employeeId][day] = status;
            } else {
                delete attendanceData[employeeId][day];
            }
            saveAttendanceToStorage(); // Save data on every update
            render(); 
        }

        // --- UI & ROLE MANAGEMENT ---
        function populateUserDropdown() {
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '';
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name;
                userSelect.appendChild(option);
            });
        }
        
        function setCurrentUser(userId) {
            const selectedEmployee = employees.find(emp => emp.id === userId);
            if (selectedEmployee) {
                currentUserInfo = {
                    ...selectedEmployee,
                    isAdmin: selectedEmployee.name === ADMIN_NAME
                };
            }
             console.log("Current user set to:", currentUserInfo);
        }

        // --- RENDERING ---
        function render() {
            renderHeader();
            renderBody();
        }

        function renderHeader() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const head = document.getElementById('timesheet-head');
            let headerHTML = `<tr><th class="p-2 w-48 text-left">Họ và Tên</th><th class="p-2 w-36 text-left">Chức vụ</th>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const isWeekend = new Date(year, month, day).getDay() % 6 === 0;
                headerHTML += `<th class="p-2 text-center w-12 ${isWeekend ? 'weekend' : ''}">${day}</th>`;
            }
            Object.values(STATUS_COUNT).forEach(status => { headerHTML += `<th class="p-2 w-20">${status.label}</th>`; });
            headerHTML += `</tr><tr><th></th><th></th>`;
            const weekdays = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = new Date(year, month, day).getDay();
                headerHTML += `<th class="p-2 text-xs font-normal ${dayOfWeek % 6 === 0 ? 'weekend' : ''}">${weekdays[dayOfWeek]}</th>`;
            }
            Object.values(STATUS_COUNT).forEach(() => { headerHTML += `<th></th>`; });
            headerHTML += `</tr>`;
            head.innerHTML = headerHTML;
            document.getElementById('current-month-display').innerText = `Tháng ${month + 1}, ${year}`;
        }

        function renderBody() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const body = document.getElementById('timesheet-body');
            let bodyHTML = '';

            employees.forEach(emp => {
                const empAttendance = attendanceData[emp.id] || {};
                const summaries = Object.keys(STATUS_COUNT).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});
                for (let day = 1; day <= daysInMonth; day++) {
                    const status = empAttendance[day];
                    if (status) {
                        for (const [summaryKey, config] of Object.entries(STATUS_COUNT)) {
                            if (config.statuses[status]) summaries[summaryKey] += config.statuses[status];
                        }
                    }
                }
                
                bodyHTML += `<tr><td class="p-2 text-left font-medium">${emp.name}</td><td class="p-2 text-left text-gray-600">${emp.position}</td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const isWeekend = new Date(year, month, day).getDay() % 6 === 0;
                    const status = empAttendance[day] || '';
                    const statusInfo = STATUS_MAP[status] || { text: '', class: '' };
                    bodyHTML += `<td data-employee-id="${emp.id}" data-day="${day}" class="p-2 cursor-pointer hover:bg-yellow-100 transition-colors ${isWeekend ? 'weekend' : ''} ${statusInfo.class}">${statusInfo.text}</td>`;
                }
                Object.values(summaries).forEach(val => { bodyHTML += `<td class="p-2 font-bold">${val || 0}</td>`; });
                bodyHTML += `</tr>`;
            });
            body.innerHTML = bodyHTML;
        }

        // --- ACTION HANDLERS ---
        function handleMonthChange(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            loadAttendanceFromStorage(); // Load data for the new month
            render();
        }
        
        function handleToday() {
            currentDate = new Date();
            loadAttendanceFromStorage();
            render();
        }

        // --- EVENT LISTENERS ---
        document.getElementById('prev-month-btn').addEventListener('click', () => handleMonthChange(-1));
        document.getElementById('next-month-btn').addEventListener('click', () => handleMonthChange(1));
        document.getElementById('today-btn').addEventListener('click', handleToday);
        document.getElementById('export-csv-btn').addEventListener('click', () => { alert('Chức năng xuất file sẽ được bổ sung.'); });

        document.getElementById('user-select').addEventListener('change', (e) => {
            setCurrentUser(e.target.value);
        });

        document.getElementById('timesheet-body').addEventListener('click', (e) => {
            const cell = e.target.closest('td');
            if (!cell || !cell.dataset.employeeId || !currentUserInfo.isAdmin) {
                if (cell && !currentUserInfo.isAdmin) {
                    alert('Bạn không có quyền chỉnh sửa. Vui lòng chọn tài khoản Admin.');
                }
                return;
            }
            
            const { employeeId, day } = cell.dataset;
            const rect = cell.getBoundingClientRect();
            popover.classList.remove('hidden');
            popover.style.left = `${rect.left + window.scrollX}px`;
            popover.style.top = `${rect.bottom + window.scrollY + 5}px`;
            currentCell = { employeeId, day };
        });

        popover.addEventListener('click', (e) => {
            const button = e.target.closest('.status-btn');
            if (button) {
                const { employeeId, day } = currentCell;
                if (employeeId && day) {
                    updateAttendance(employeeId, day, button.dataset.status);
                }
                popover.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!popover.contains(e.target) && !e.target.closest('td[data-employee-id]')) {
                 popover.classList.add('hidden');
            }
        });

        // --- STARTUP ---
        function startup() {
            loadInitialData();
            loadAttendanceFromStorage();
            populateUserDropdown();
            // Set the initial user to the first one in the list
            if (employees.length > 0) {
                setCurrentUser(employees[0].id);
                document.getElementById('user-select').value = employees[0].id;
            }
            render();
        }

        startup();
    </script>
</body>
</html>

